/* Version: V_06 */
/* Header bidding from Impression Media 
 * Generate by script: updateCodeGoogleDevelopment     
 * Last update: 16.06.2022 12:12:08
 * Ticket ID: ... / [1371]
 * Generated for WebSite: [https://zena-in.cz]
 * User ID: [1]    
 * Custom ticket name: [zena-in.cz - P6 new sharedIdSystem (od 23.5.2022)]
 * Project date: 23.8.2019 by Weuron s.r.o. 
*/

var imCurrentSc = document.currentScript.src;
var imCDN;
if (imCurrentSc.toLowerCase().indexOf('jsdelivr') >= 0){ var imCDN = 1; }else{ var imCDN = 0; }
console.log('imCDN: '+imCDN);


//document.addEventListener('DOMContentLoaded', (event) => {
//    var imHbDomContentLoaded = 'ImHbIsReady';
//    console.log('DOM event fully loaded and parsed');
//}); 

//document.onreadystatechange = () => {
//  console.log('DOM readyState: '+document.readyState);
//  if (document.readyState === 'complete') {
//    console.log('DOM event readyState complete');
//  }
//};    



    
function newIndividualCss(css, id){
    console.log('Fire newIndividualCss: '+id);
    var styleNode, selection;
    var contentStyleTop = css;
    if ((styleNode = top.document.createElement("style")).id = "imHb-"+id, styleNode.type = "text/css", window.attachEvent && !window.opera){ 
        styleNode.styleSheet.cssText = contentStyleTop;
        console.log('imHB branding :: chrom OK: '+contentStyleTop);
    }else{
        var styleText = document.createTextNode(contentStyleTop);
        styleNode.appendChild(styleText)
    }
    top.document.getElementsByTagName("head")[0].appendChild(styleNode);
}

function newBehaviourBranding(unitCustomID){
    console.log('Fire fc newBehaviourBranding()');

//    responsiveConditionReady = document.querySelector(".box-imHbBrandingRam") !== null;                
//    if (responsiveConditionReady) {
//        console.log('1b body > .box-imHbBrandingRam fire remove');    
//        document.querySelector("body > .box-imHbBrandingRam").remove();
//    }

    var imHbBrandigDiv = document.createElement('div');
    imHbBrandigDiv.className = 'box-imHbBrandingRam';
    imHbBrandigDiv.innerHTML = '<div class="imHbBrandingRam fcNewBehaviourBranding" style="position: absolute; width: 100%; height: auto; z-index: 0; min-height: 0px;"><div id="'+unitCustomID+'" class="imHbUnitCustomID" style="width: 2000px; min-height: 0px; height: auto;overflow: visible;top: 0px;position: fixed; z-index: 0;left: 50%;margin-left: -1000px;display: block;pointer-events: auto !important;"></div></div>';
    document.body.insertBefore(imHbBrandigDiv, document.body.childNodes[0]);

}
setTimeout(function(){
    responsiveConditionReady = document.querySelector(".box-imHbBrandingRam") !== null;                
    if (responsiveConditionReady) {
        var allImHbBrandingRams = document.querySelectorAll(".box-imHbBrandingRam");
        for (var i = 0, element; element = allImHbBrandingRams[i]; i++) {
            //work with element
            responsiveConditionReady = element.querySelector("iframe") !== null;
            if (responsiveConditionReady) {}else{console.log('timeout box-imHbBrandingRam fire remove'); element.remove();}
        }
    }
}, 4000); 


//verze branding = slepÃ¡ kolej 
//top.document.body.classList.remove("imHbBranding");
responsiveConditionReady = document.querySelector(".box-imHbBrandingRam #brandingPlus") !== null;                
if (responsiveConditionReady) {
    console.log('fire rename brandingPlus');
    var imHbSmazAzOnload = document.querySelector(".box-imHbBrandingRam #brandingPlus");
    imHbSmazAzOnload.setAttribute("id","old-brandingPlus");
}

        
function imHbadform_leaderboard2(){
    console.log('ID: adform_leaderboard2 >> OK: ' + responsiveConditionReady); 
    responsiveConditionReady = document.querySelector("#adform_leaderboard2").innerHTML;            
    if(responsiveConditionReady == ''){
        console.log('Content in ID: adform_leaderboard2 is empty');
    }else{
        console.log('Fire remove content in ID: adform_leaderboard2 >> HTML: '+ responsiveConditionReady); 
        document.querySelector("#adform_leaderboard2").innerHTML = '';            
    }
    setTimeout(function(){                  
        var ifrimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2 > div > iframe") !== null;;
        if (ifrimHbadform_leaderboard2) { 
            ifrimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2 > div > iframe");
            console.log('1x600 Fire ifrimHbadform_leaderboard2');
            var divIdimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2");
            console.log('ifrimHbadform_leaderboard2.height: '+ifrimHbadform_leaderboard2.height);
            divIdimHbadform_leaderboard2.style.minHeight = ifrimHbadform_leaderboard2.height+'px';
        }else{
            setTimeout(function(){
                ifrimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2 > div > iframe") !== null;;
                if (ifrimHbadform_leaderboard2) { 
                    ifrimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2 > div > iframe");
                    console.log('2x600 Fire ifrimHbadform_leaderboard2');
                    var divIdimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2");
                    console.log('ifrimHbadform_leaderboard2.height: '+ifrimHbadform_leaderboard2.height);
                    divIdimHbadform_leaderboard2.style.minHeight = ifrimHbadform_leaderboard2.height+'px';
                }else{
                    setTimeout(function(){
                        ifrimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2 > div > iframe") !== null;;
                        if (ifrimHbadform_leaderboard2) { 
                            ifrimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2 > div > iframe");
                            console.log('3x600 Fire ifrimHbadform_leaderboard2');
                            var divIdimHbadform_leaderboard2 = document.querySelector("#adform_leaderboard2");
                            console.log('ifrimHbadform_leaderboard2.height: '+ifrimHbadform_leaderboard2.height);
                            divIdimHbadform_leaderboard2.style.minHeight = ifrimHbadform_leaderboard2.height+'px';
                        }
                    }, 600);            
                }
            }, 600);            
        }
    }, 600);
                    
}
var imHbadform_leaderboard2Count = 0;
function imHbadform_leaderboard2Fire(){
//    console.log('Fire fc imHbadform_leaderboard2Fire()');
    responsiveConditionReady = document.querySelector("#adform_leaderboard2") !== null;
    if (responsiveConditionReady) {
        imHbadform_leaderboard2();
    }else{
//        console.log('ID: adform_leaderboard2 >> NOT found: ' + responsiveConditionReady);
//        console.log('imHbadform_leaderboard2Count: '+ imHbadform_leaderboard2Count);  
        imHbadform_leaderboard2Count = imHbadform_leaderboard2Count + 1;
        if(imHbadform_leaderboard2Count < 20){
            setTimeout(function(){ imHbadform_leaderboard2Fire(); }, 100);            
        }
    }
} 
imHbadform_leaderboard2Fire(); 

    



(function(window, document, pbjs, googletag) {
'use strict';

if (typeof(hbManager) !== 'undefined') return;

var PREBID_TIMEOUT = 2500; // ms
var FAILSAFE_TIMEOUT = 2500; // ms
var REFRESH_ONRESIZE = false;
var DFP_PAGEURL = "";
var DFP_SRA = false;
var YBCI = false;
var YBCI_DOMAIN = "";
var YBCI_ID = "";
var APS = false;
var APS_PUBID = "";
var placementFloor = {};

var imHbWindowWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
var hbPlacement;


//var adUnits = [
var adUnits = [];

// 1. --------------------------------
// Web Variableexclude#@##@#
// without setting for Web Variable
console.log('no Web Variable');
// 2. --------------------------------
// URL condition:include#@#regex#@#.*            
var patt = new RegExp('.*');
var urlCondition = patt.test(location.pathname);
if(urlCondition){

// 3. --------------------------------
// unitResponzivita:All
  if(((imHbWindowWidth >= 1) && (imHbWindowWidth <= 9999))){
    console.log('Responzivita = TRUE >> Placement adform_leaderboard2 / imHbWindowWidth: (' + imHbWindowWidth + ')');
    var check911732 = document.querySelector("#adform_leaderboard2") !== null;
    console.log('ID: adform_leaderboard2 / check911732: ' + check911732);

// 4. --------------------------------
// unitAutoDivIdControl:0

placementFloor['adformleaderboard2'] = '0.00';
adUnits.push(
                                       // if unitStavRP = 1
    {
    "hbm_zone": {
        "userid": 1,
        "websiteid": 1371,
        "zoneid": 911732,                                                              //id
        "lazy_loading": 0,                                           //unitLazyLoading
        "lazy_loading_offset": 100,                                     //unitLazyPixelu
        "refresh": 0,                                 //unitAutoRefreshNumber if(unitAutoRefresh==0)>>0
        "refresh_limit": 3,                                    //unitAutoRefreshLimit            
        "nontracked": 0,                                             //unitSizeMapping
        "outofpage": 0,                                            //unitMinimalScreen
        "slot_code": "/96856532/TT-Zena-in.cz-CW-Leaderboard-patickovy-1000-300-GAM",                 //unitSlotGAD
        "slot_sizes": [                                           //unitBannerSize
                [
                    1000,                                          //unitBannerSize
                    300                                           //unitBannerSize
                ],
                [
                    970,                                          //unitBannerSize
                    250                                           //unitBannerSize
                ],
                [
                    970,                                          //unitBannerSize
                    210                                           //unitBannerSize
                ],
                [
                    728,                                          //unitBannerSize
                    90                                           //unitBannerSize
                ],
                [
                    1000,                                          //unitBannerSize
                    200                                           //unitBannerSize
                ],
                [
                    1000,                                          //unitBannerSize
                    210                                           //unitBannerSize
                ],
                [
                    900,                                          //unitBannerSize
                    200                                           //unitBannerSize
                ],
                [
                    970,                                          //unitBannerSize
                    200                                           //unitBannerSize
                ],
                [
                    1000,                                          //unitBannerSize
                    100                                           //unitBannerSize
                ],
                [
                    980,                                          //unitBannerSize
                    250                                           //unitBannerSize
                ],
                [
                    745,                                          //unitBannerSize
                    100                                           //unitBannerSize
                ],
                [
                    745,                                          //unitBannerSize
                    200                                           //unitBannerSize
                ],
                [
                    970,                                          //unitBannerSize
                    100                                           //unitBannerSize
                ],
                [
                    970,                                          //unitBannerSize
                    90                                           //unitBannerSize
                ],
                [
                    998,                                          //unitBannerSize
                    200                                           //unitBannerSize
                ],
                [
                    990,                                          //unitBannerSize
                    100                                           //unitBannerSize
                ],
                [
                    750,                                          //unitBannerSize
                    200                                           //unitBannerSize
                ],
                [
                    750,                                          //unitBannerSize
                    100                                           //unitBannerSize
                ],
            ]
        },
        "code": "adform_leaderboard2",

        "mediaTypes": {
            "banner": {
                "sizes": [ //unitBannerSize
                        [
                            1000,                                          //unitBannerSize
                            300                                           //unitBannerSize
                        ],
                        [
                            970,                                          //unitBannerSize
                            250                                           //unitBannerSize
                        ],
                        [
                            970,                                          //unitBannerSize
                            210                                           //unitBannerSize
                        ],
                        [
                            728,                                          //unitBannerSize
                            90                                           //unitBannerSize
                        ],
                        [
                            1000,                                          //unitBannerSize
                            200                                           //unitBannerSize
                        ],
                        [
                            1000,                                          //unitBannerSize
                            210                                           //unitBannerSize
                        ],
                        [
                            900,                                          //unitBannerSize
                            200                                           //unitBannerSize
                        ],
                        [
                            970,                                          //unitBannerSize
                            200                                           //unitBannerSize
                        ],
                        [
                            1000,                                          //unitBannerSize
                            100                                           //unitBannerSize
                        ],
                        [
                            980,                                          //unitBannerSize
                            250                                           //unitBannerSize
                        ],
                        [
                            745,                                          //unitBannerSize
                            100                                           //unitBannerSize
                        ],
                        [
                            745,                                          //unitBannerSize
                            200                                           //unitBannerSize
                        ],
                        [
                            970,                                          //unitBannerSize
                            100                                           //unitBannerSize
                        ],
                        [
                            970,                                          //unitBannerSize
                            90                                           //unitBannerSize
                        ],
                        [
                            998,                                          //unitBannerSize
                            200                                           //unitBannerSize
                        ],
                        [
                            990,                                          //unitBannerSize
                            100                                           //unitBannerSize
                        ],
                        [
                            750,                                          //unitBannerSize
                            200                                           //unitBannerSize
                        ],
                        [
                            750,                                          //unitBannerSize
                            100                                           //unitBannerSize
                        ]
                ]
            }
        },
        "labelAny": ["all"],
        "bids": [
                                                              //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "cpex-tt",
                "labelAny": ["all"],        
                    "params": {
                               accountId: 10900,                        //int (cpex-tt >> accountId) // paramsAllBidders [@@@][::]
                               siteId: 142998,                        //int (cpex-tt >> siteId) // paramsAllBidders [@@@][::]
                               zoneId: 1592070,                        //int (cpex-tt >> zoneId) // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "criteo-im",
                "labelAny": ["all"],        
                    "params": {
                               networkId: 7456,                        //int (criteo-im >> networkId) // paramsAllBidders [@@@][::]
                               publisherSubId: "zena-in/Leaderboard_paticka_774940",                        //varchar (criteo-im >> publisherSubId) // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "adform-im-tt",
                "labelAny": ["all"],        
                    "params": {
                               mid: 774940,                        //int cislaOstatni // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "cpex-nt",
                "labelAny": ["all"],        
                    "params": {
                               accountId: 10900,                        //int (cpex-nt >> accountId) // paramsAllBidders [@@@][::]
                               siteId: 143000,                        //int (cpex-nt >> siteId) // paramsAllBidders [@@@][::]
                               zoneId: 1592072,                        //int (cpex-nt >> zoneId) // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "adform-im-nt",
                "labelAny": ["all"],        
                    "params": {
                               mid: 774944,                        //int cislaOstatni // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "r2b2",
                "labelAny": ["all"],        
                    "params": {
                               d: "im.zena-in.cz",                        //varchar cislaOstatni // paramsAllBidders [@@@][::]
                               g: "hb",                        //varchar cislaOstatni // paramsAllBidders [@@@][::]
                               p: "998x200",                        //varchar cislaOstatni // paramsAllBidders [@@@][::]
                               m: 0,                        //int cislaOstatni // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "appnexus",
                "labelAny": ["all"],        
                    "params": {
                               placementId: 18489636,                        //int (appnexus >> placementId) // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "PubMatic",
                "labelAny": ["all"],        
                    "params": {
                               publisherId: "158732",                        //varchar cislaOstatni // paramsAllBidders [@@@][::]
                               adSlot: "3065062",                        //varchar cislaOstatni // paramsAllBidders [@@@][::]
                               currency: "USD",                        //varchar cislaOstatni // paramsAllBidders [@@@][::]    
                    }                
            },                                                  //explode paramsAllBidders (bidders) 
            {                                                 //paramsAllBidders [;;;]
                "bidder": "adform-omd",
                "labelAny": ["all"],        
                    "params": {
                               mid: 1186608,                        //int cislaOstatni // paramsAllBidders [@@@][::]    
                    }                
            }
        ]
    }
); //end push    

}else{
    console.log('Responzivita = FALSE >> Placement adform_leaderboard2 / imHbWindowWidth: (' + imHbWindowWidth + ')');
    var check911732 = document.querySelector("#adform_leaderboard2") !== null;
    console.log('ID: adform_leaderboard2 / check911732: ' + check911732);

  }

}else{
    console.log('URL condition >>  include / typ regex / string: .*');
}

//];


    var customPriceGranularity = {  //musi byt v dolarech
        "buckets": [
                {
                'precision': 2,
                'max': 0.434781085,
                'increment': 0.0869565217
            },
            {
                'precision': 2,                    
                'max': 1.3043463,
                'increment': 0.173913043
            },
            {
                'precision': 2,                    
                'max': 5.21738978,
                'increment': 0.652173913
            }
        ]
    };    
    

var adConfig = {
       "priceGranularity": customPriceGranularity,
//    "priceGranularity": "custom",
//    "mediaTypePriceGranularity": {
//          'video': customPriceGranularity,
//	  'video-outstream': customPriceGranularity,
//          'banner': customPriceGranularity,
//          'native': customPriceGranularity,
//        },
    "currency": {
        "adServerCurrency": "CZK",                                        //gamCurrency
        "granularityMultiplier": 23                               //nasobitelGranularity
    },
    cache: {
        url: "https://prebid.adnxs.com/pbc/v1/cache"
    },   
    
    schain: {
        'validation': 'strict',
        'config': {
            'ver': '1.0',
            'complete': 1,
            'nodes': [{ 'asi': 'cpex.cz', 'sid': '011', 'hp': 1 }]
        }
    },

    consentManagement: {
        gdpr: {
          cmpApi: 'iab',
          timeout: 8000,
          defaultGdprScope: true,   //TCF v2.0
          allowAuctionWithoutConsent: true  //TCF v1.1
        }

//	gdpr: {
//		cmpApi: 'iab',
//		timeout: 8000,
//		defaultGdprScope: true // TCF 2.0 & PBJS v4+
//	},
//	usp: {
//		cmpApi: 'iab',
//		timeout: 8000
//	}
    },        
    
       sizeConfig: [{
                       "mediaQuery": '(min-width: 1px) and (max-width: 9999px)', 
                        "labels": [ "all"]
                    }, 
                {
                       "mediaQuery": '(min-width: 1200px)',  
                        "labels": [ "desktop"]
                    }, 
                ],
        
    "enableSendAllBids": false,                                   //zatim fix >> GAM API + http://prebid.org/dev-docs/publisher-api-reference.html#setConfig-Send-All-Bids

    "publisherDomain": "https://zena-in.cz",                 //http://prebid.org/sandbox/prebid-api-guide.html?apiDocTarget=configuration&apiDefinition=publisherDomain#apiDocs

    "maxRequestsPerOrigin": 4,                                //http://prebid.org/dev-docs/publisher-api-reference.html#setConfig-Max-Requests-Per-Origin

        userIds:[
            {name: 'sharedId',
                storage: {
                    name: '_sharedID',
                    type: 'cookie',
                    expires: 30
                }
            },
            {name:'criteo'}
        ]
    
}; //end adConfig

if (APS) {
	!function(a9,a,p,s,t,A,g){if(a[a9])return;function q(c,r){a[a9]._Q.push([c,r])}a[a9]={init:function(){q("i",arguments)},fetchBids:function(){q("f",arguments)},setDisplayBids:function(){},targetingKeys:function(){return[]},_Q:[]};A=p.createElement(s);A.async=!0;A.src=t;g=p.getElementsByTagName(s)[0];g.parentNode.insertBefore(A,g)}("apstag",window,document,"script","//c.amazon-adsystem.com/aax2/apstag.js");
}

(function () {
	if ('IntersectionObserver' in window &&
		'IntersectionObserverEntry' in window &&
		'intersectionRatio' in window.IntersectionObserverEntry.prototype) return;
	var plf = document.createElement('script');
	plf.type = 'text/javascript';
	plf.async = true;
	plf.src = '//hb-testing.progsol.cz/prebid/polyfill.min.js';                                //bez zaruky >> nastaveni dle vzoru
	var target = document.getElementsByTagName('head')[0];
	target.insertBefore(plf, target.firstChild);
	window.hbm_polyfill = plf;
})();


if (YBCI) {                                                                                         //zatim false viz radek c.55
	window.yb_configuration = {"domain": YBCI_DOMAIN, "lazyLoad": true};
	(function (y, i, e, l, d, b, I, R, D) {
		d.Yieldbird = d.Yieldbird || {};
		d.Yieldbird.cmd = d.Yieldbird.cmd || [];
		l.cmd.push(function () {l.pubads().disableInitialLoad();});
		b = i.createElement('script'); b.async = true;
		b.src = (e === 'https:' ? 'https:' : 'http:') + '//jscdn.yieldbird.com/' + y + '/yb.js';            
		I = i.getElementsByTagName('script')[0];
		(I.parentNode || i.head).insertBefore(b, I);
	})(YBCI_ID, document, document.location.protocol, googletag, window);
}

// start escape !!
// ---------------------------------------------------------------------------------------------------------------------
// ---------------------------------------------------------------------------------------------------------------------
// ---------------------------------------------------------------------------------------------------------------------


function getCpm(bidCpm, bid, pubshare, floor) {

	console.log('getCpm >> ('+bid.bidder+') >> bidCpm: ' + bidCpm);
	console.log('getCpm >> ('+bid.bidder+') >> bid ^^');
	console.log(bid);
        console.log('getCpm >> ('+bid.bidder+') >> pubshare: ' + pubshare);
        console.log('getCpm >> ('+bid.bidder+') >> floor: ' + floor);        
//        if(bid.currency != bid.originalCurrency){
//            var cpmInCZK = (typeof bid.getCpmInNewCurrency === "function") ? bid.getCpmInNewCurrency('CZK') : bid.originalCpm;
//        }else{
            if(bid.currency != 'CZK'){
                console.log('bid.currency != CZK ' + bid.currency);
                var cpmInCZK = bid.cpm * 23;
                    bidCpm = cpmInCZK;
            }else{
                var cpmInCZK = bid.cpm;
            }
//        }
	
        
        console.log('getCpm >> ('+bid.bidder+') >> cpmInCZK: ' + cpmInCZK);
        
        console.log('getCpm >> ('+bid.bidder+') >> bid.currency: ' + bid.currency);
        console.log('getCpm >> ('+bid.bidder+') >> bid.originalCurrency: ' + bid.originalCurrency);        
        console.log('getCpm >> ('+bid.bidder+') >> --------------------------------------------------------- ');
        console.log('getCpm >> ('+bid.bidder+') >> cpmInCZK * pubshare = ' + (cpmInCZK * pubshare));
        console.log('getCpm >> ('+bid.bidder+') >> floor:' + floor);

        if(placementFloor[bid.adUnitCode.replace(/-|_/g, "")]>0){
           floor = placementFloor[bid.adUnitCode.replace(/-|_/g, "")];
           console.log('getCpm >> ('+bid.adUnitCode.replace(/-|_/g, "")+') >> placementFloor:' + floor);           
        }


        if(cpmInCZK * pubshare < floor){
            console.log('getCpm >> ('+bid.bidder+') >> if (cpmInCZK * pubshare < floor) ');
            console.log('getCpm >> ('+bid.bidder+') >> cpm is: 0');        
            return 0;
	}else{
            console.log('getCpm >> ('+bid.bidder+') >> if (cpmInCZK * pubshare < floor) ');
            console.log('getCpm >> ('+bid.bidder+') >> bidCpm * pubshare: ' + (bidCpm * pubshare));
        }
	return bidCpm * pubshare; 
}




function getBidderCode(bidderCode) {
	if (adBidders && adBidders[bidderCode]) {
		bidderCode += ',' + adBidders[bidderCode];
	}
	return bidderCode; 
}


// ---------------------------------------------------------------------------------------------------------------------
// ---------------------------------------------------------------------------------------------------------------------
// ---------------------------------------------------------------------------------------------------------------------

pbjs.setConfig(adConfig);

pbjs.que.push(function() {
	pbjs.bidderSettings = {
            "cpex-tt": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "criteo-im": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "adform-im-tt": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.9, 3) }
            },
            "cpex-nt": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "adform-im-nt": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "r2b2": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "mgid": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "appnexus": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "stroeerCore": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "adform-omd": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "rtbhouse": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "PubMatic": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "Teads": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            "ix": { 
                bidCpmAdjustment: function(bidCpm, bid) { return getCpm(bidCpm, bid, 0.8, 3) }
            },
            
    };
    pbjs.addAdUnits(adUnits);
    pbjs.aliasBidder('rubicon', 'cpex-tt');
    pbjs.aliasBidder('criteo', 'criteo-im');
    pbjs.aliasBidder('adform', 'adform-im-tt');
    pbjs.aliasBidder('rubicon', 'cpex-nt');
    pbjs.aliasBidder('adform', 'adform-im-nt');
    pbjs.aliasBidder('adform', 'adform-omd');
    pbjs.aliasBidder('pubmatic', 'PubMatic');
    


//statistika
function statisticsAuctionEnd(data, kam){
    console.log('fire post data auctionEnd: '+kam);
    console.log(data);
    if(typeof data === 'object'){
        if(data.ext){
            data.ext = null;
            console.log('fire data ext(R2B2)');
            console.log(data);
        }else{
            console.log('fire NO data ext(R2B2)');        
        }
    }
//    var strData = JSON.stringify(data);
    var strData = encodeURIComponent(JSON.stringify(data));    
    console.log('strData: '+strData);

    var hbmasterscript = 'hb-0';
    if(null != top.document.body.getAttribute("data-hbmasterscript")){
        hbmasterscript = top.document.body.getAttribute("data-hbmasterscript"); 
    }

    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://hb.impressionmedia.cz/statistics/'+kam+'.php?configId=1371&statistics=1&groupBidsReceivedTable=4&groupRandId=7&hbmasterscript='+hbmasterscript+'&data='+strData);
//    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = function () {
      // In local files, status is 0 upon success in Mozilla Firefox
      if(xhr.readyState === XMLHttpRequest.DONE) {
        var status = xhr.status;
        if (status === 0 || (status >= 200 && status < 400)) {
          // The request has been completed successfully
          console.log('xhr.responseText');          
          console.log(status + ': ' + xhr.responseText);
        } else {
            console.log('error in xhr');
          // Oh no! There has been an error with the request!
        }
      }
    };
    xhr.send();

}

//	pbjs.onEvent('bidRequested', function(data){
//		for (var i in data.bids) {
//			var u = adUnits.filter(function(u) {
//				return u.code === data.bids[i].adUnitCode;
//			})[0];
//			if (!u) return;
//                        //if (!u.userId) u.userId = {};
//			//u.userId = {pubcid: 'test2'};
//			if (!u.hbm_stats) u.hbm_stats = [];
//			u.hbm_stats.push({
//				event: 'bidRequested',
//				v: 'v2',
//				user_id: u.hbm_zone.userid,
//				website_id: u.hbm_zone.websiteid,
//				zone_id: u.hbm_zone.zoneid,
//				bidderCode: getBidderCode(data.bids[i].bidder),
//				refresh: u.hbm_zone.isRefresh ? 't' : '',
//			});
//		}
//	});

	pbjs.onEvent('auctionInit', function(data){
		for (var i in data.adUnitCodes) {
			var u = adUnits.filter(function(u) {
				return u.code === data.adUnitCodes[i];
			})[0];
			if (!u) return;
                        //if (!u.userId) u.userId = {};
			//u.userId = {pubcid: 'test'};                        
			if (!u.hbm_stats) u.hbm_stats = [];
			u.hbm_stats.push({
				event: 'auctionInit',
				v: 'v2',
				user_id: u.hbm_zone.userid,
				website_id: u.hbm_zone.websiteid,
				zone_id: u.hbm_zone.zoneid,
				refresh: u.hbm_zone.isRefresh ? 't' : '',
			});
		}
	});


pbjs.onEvent('auctionDebug', function(data){
    console.log('start onEvent auctionDebug');
    console.log('data^');    
    console.log(data);  
    if(data.type == 'ERROR'){
        if(data.arguments[0]=='CMP workflow exceeded timeout threshold. Canceling auction as per consentManagement config.'){
            console.log('fire CMP timeout');
            console.log(imHbAsocPlacementMidEnable);
            var potencial = 0;
            for (var key in imHbAsocPlacementMidEnable) {
                console.log(imHbAsocPlacementMidEnable[key]);
                potencial++;
            }
            console.log('potencial: '+potencial);
            statisticsAuctionEnd(potencial, 'cmpTimeout');
            if (typeof __tcfapi === 'function') { 
                __tcfapi('getTCData', 2, cmpStatistika);
            }
        }else{
            console.log(data.arguments[0]);
        }
    }
    console.log('end onEvent auctionDebug');
});

pbjs.onEvent('auctionEnd', function(data){
    var dataAdUnitCodesString = data.adUnitCodes[0];
    console.log('auctionEnd statisticsAuctionEnd: '+dataAdUnitCodesString);
    console.log(data);
    console.log('check caroda: '+dataAdUnitCodesString.indexOf('caroda'));
    if(dataAdUnitCodesString.indexOf('caroda') > -1){
        console.log('jump caroda');
    }else{

        console.log('data.bidsReceived^^');
        console.log(data.bidsReceived);
        for (var i in data.bidsReceived) {
            if(!isNaN(i)){
                console.log(i + '. auEnd|Received: ' + data.bidsReceived[i].bidderCode); 
                var dataWithoutAd = JSON.parse(JSON.stringify(data.bidsReceived[i]));
                dataWithoutAd.ad = '';
                console.log('dataWithoutAd^^');
                console.log(dataWithoutAd);
                statisticsAuctionEnd(dataWithoutAd, 'bidsReceived');
                dataWithoutAd = {};
            }
        }

        setTimeout(function(){
            var updateRezim = 'biddersDetail';
            var nobids = data.noBids.length;
            var auctionStatus = data.auctionStatus;
            console.log('bidderRequestsShortAuctionSum data.noBids^^'); 
            console.log(data);
            var biddersRequestDetail = data.noBids[0].bidder;
            var biddersRequestIdDetail = data.noBids[0].bidderRequestId;
            var adUnitCodeDetail = data.noBids[0].adUnitCode;           
            console.log('bidderRequestsShortAuctionSum: '+auctionStatus+'|'+nobids+'|'+biddersRequestDetail+'|'+updateRezim+'|'+data.auctionId+'|'+biddersRequestIdDetail+'|'+adUnitCodeDetail);
            statisticsAuctionEnd(auctionStatus+'|'+nobids+'|'+biddersRequestDetail+'|'+updateRezim+'|'+data.auctionId+'|'+biddersRequestIdDetail+'|'+adUnitCodeDetail, 'bidderRequestsShortAuctionSum');
        }, 500);
        
        setTimeout(function(){
            console.log('/statistics - start');
            console.log(pbjs);
            console.log(pbjs.adUnits); 
            console.log('/statistics - ready');
            //delete pbjs.adUnits;
            console.log('data >> fc pbjs.getUserIds()');
            console.log(pbjs.getUserIds(data));
            console.log('/statistics - end');
            console.log(pbjs.adUnits);
        }, 3000);

    } //no caroda
    console.log('end onEvent auctionEnd');
});

pbjs.onEvent('bidTimeout', function(data){
    console.log('pbjsonEvent >> bidTimeout^^'); 
    console.log(data);   

    //statisticsAuctionEnd(data.auctionId, 'bidTimeout');
});




	pbjs.onEvent('bidWon', function(data){       
            console.log('pbjsonEvent >> bidWon^^'); 
            console.log(data);
            console.log('pbjsonEvent >> bidWon >> currency: ' + data.currency + ' // originalCurrency: ' +  data.originalCurrency );

            console.log('bidWon statisticsAuctionEnd: '+data.adUnitCode);
            
            statisticsAuctionEnd(data.requestId+'|'+data.auctionId, 'bidsWon');
	});
	
});

//function sendStatistics(code) {}

googletag.cmd.push(function() {
	googletag.pubads().disableInitialLoad();
	googletag.pubads().addEventListener('slotOnload', function(event) {
		adUnits.filter(function(u) {
			return u.hbm_zone.slot === event.slot;
		}).forEach(function(u) {
			//sendStatistics(u.code);
		});
	});
	adUnits.forEach(function(u) {

		if (u.code) {
			if (u.hbm_zone.outofpage)
				u.hbm_zone.slot = googletag.defineOutOfPageSlot(u.hbm_zone.slot_code, u.code);
			else
				u.hbm_zone.slot = googletag.defineSlot(u.hbm_zone.slot_code, u.hbm_zone.slot_sizes, u.code);
			if (adMapping[u.hbm_zone.zoneid])
				u.hbm_zone.slot.defineSizeMapping(adMapping[u.hbm_zone.zoneid]);
			u.hbm_zone.slot.addService(googletag.pubads());
		}
	});
	if (DFP_PAGEURL !== '')
		googletag.pubads().set('page_url',DFP_PAGEURL);
	googletag.pubads().collapseEmptyDivs();
	googletag.pubads().setCentering(true);
	if (DFP_SRA)
		googletag.pubads().enableSingleRequest();
	googletag.enableServices();
});

if (APS) {
	apstag.init({
		pubID: APS_PUBID,
		adServer: 'googletag',
	});
}

pbjs.que.push(function () {

        var checkMediaQuery = [];  //jaja
        var checkUnitMediaQuery = '';  //jaja 

	var units = adUnits.filter(function(u) {
                console.log('-----------------------------------');
                console.log('u.labelAny: '+u.labelAny);
                console.log(u);  
                checkUnitMediaQuery = 'nonSet';  //jaja 


                if (u.labelAny[0]!='notResponzive'){    //jaja
                    if (u.labelAny.length == 1){
                        adConfig.sizeConfig.forEach(function(aSizeConfig){
                            if(aSizeConfig.labels[0]){
//                                console.log('aSizeConfig.labels[0]: '+aSizeConfig.labels[0]);
                            }else{
//                                console.log('Not set aSizeConfig.labels[0]');
                            }
                        
                            if(aSizeConfig.labels[0]==u.labelAny[0]){                            
//                              console.log('u.labelAny[0]'+u.labelAny[0]+'  vs aSizeConfig.mediaQuery'+aSizeConfig.mediaQuery );
                              var x = window.matchMedia(aSizeConfig.mediaQuery);      
                              if (x.matches) { 
//                                console.log('if x.matches');
//                                console.log('u.code: '+u.code);            
                                checkMediaQuery.push(u.code);
                                checkUnitMediaQuery = 'display';                                
                              } else {
//                                console.log('else x.matches');
//                                console.log('u.code: '+u.code); 
                                checkUnitMediaQuery = 'hidden'; 
                              }
                            }else{
//                                console.log('Jiny stitek >> u.labelAny[0]'+u.labelAny[0])
                            }
                        });
                    }else if(u.labelAny.length == 2){
                    
                        var arrCheckMediaQuery = [];

                        adConfig.sizeConfig.forEach(function(bSizeConfig){
                            if((bSizeConfig.labels[0]==u.labelAny[0])||(bSizeConfig.labels[0]==u.labelAny[1])){ 
                                arrCheckMediaQuery.push(bSizeConfig.mediaQuery);
                            }
                            
                        });

                        console.log('u.labelAny[0]: '+u.labelAny[0]+ ' and u.labelAny[1]: '+u.labelAny[1]);
                        var xa = window.matchMedia(arrCheckMediaQuery[0]);  
//                        console.log('arrCheckMediaQuery[0]: '+arrCheckMediaQuery[0] + '  and arrCheckMediaQuery[1]: '+arrCheckMediaQuery[1]);
                        var xb = window.matchMedia(arrCheckMediaQuery[1]);                         
                        if (xa.matches) { 
//                            console.log('if x.matches / '+arrCheckMediaQuery[0]);
//                            console.log('u.code: '+u.code);            
                            checkMediaQuery.push(u.code);
                            checkUnitMediaQuery = 'display';
                        }
                        else if (xb.matches) { 
//                            console.log('if x.matches / '+arrCheckMediaQuery[1]);
//                            console.log('u.code: '+u.code);            
                            checkMediaQuery.push(u.code);
                            checkUnitMediaQuery = 'display';
                        }
                        else {
//                            console.log('else x.matches');
//                            console.log('u.code: '+u.code);
                            checkUnitMediaQuery = 'hidden';
                        }

                    }else{ console.log('POZOR problem'); }
                }else{
                    console.log('NO PROBLEM - bez kontroly responzivity');
                    return u.code && !u.hbm_zone.lazy_loading;
                }

            if(checkUnitMediaQuery=='display'){
                return u.code && !u.hbm_zone.lazy_loading;
            }

	});

        
        
	if (units.length === 0) return;


        console.log('===========================');
        console.log(units);
	startAuction(units);
});


function removeA(arr) {
    var what, a = arguments, L = a.length, ax;
    while (L > 1 && arr.length) {
        what = a[--L];
        while ((ax= arr.indexOf(what)) !== -1) {
            arr.splice(ax, 1);
        }
    }
    return arr;
}

function sendAdserverRequests(codes) {


	var unitsForSend = adUnits.filter(function(u) {

		if (codes.indexOf(u.code) != -1 && u.hbm_zone.unitForSend && u.hbm_zone.back >= (1 + APS)) {
			u.hbm_zone.unitForSend = false;
			return true;
		}
		return false;
	});
	if (unitsForSend.length == 0) return;

	var codesForSend = unitsForSend.map(function(u) {
		return u.code;
	});

	var slots = unitsForSend.map(function(u) {
//        console.log('u^^');        
//        console.log(u);
                //u.hbm_zone.slot.code = u.code;                         //jaja temp
                //u.hbm_zone.slot.allMedia = codesForSend;               //jaja
                //u.hbm_zone.slot.inMediaQuery = checkMediaQuery;        //jaja  
		return u.hbm_zone.slot;
	});

	googletag.cmd.push(function() {
		pbjs.que.push(function() {
			pbjs.setTargetingForGPTAsync(codesForSend);
			if (YBCI && window.Yieldbird) {
				window.Yieldbird.cmd.push(function() {
					window.Yieldbird.refresh(slots);
				});
			}
			else {
				googletag.pubads().refresh(slots);
			}
		});
	});
}

function startAuction(units) {
	var unitsForSend = units.filter(function(u) {
		u.hbm_zone.refresh_counter = u.hbm_zone.refresh_counter || 0;
		if (u.hbm_zone.isRefresh && u.hbm_zone.refresh_limit > 0 && u.hbm_zone.refresh_counter >= u.hbm_zone.refresh_limit) 
			return false;
		if (u.hbm_zone.isRefresh) u.hbm_zone.refresh_counter ++;

		u.hbm_zone.unitForSend = true;
		u.hbm_zone.back = 0;
		return true;
	});
	if (unitsForSend.length == 0) return;

	var codesForSend = unitsForSend.map(function(u) {
		return u.code;
	});

	console.log("start auction "+codesForSend.join());

	if (APS) {
		var apsSlots = [];
		unitsForSend.forEach(function(u) {
			apsSlots.push({
				slotID: u.code,
				slotName: u.hbm_zone.slot_code,
				sizes: u.hbm_zone.slot_sizes,
			});
		});

		apstag.fetchBids({
			timeout: PREBID_TIMEOUT,
			slots: apsSlots,
		}, function(bids) {
			googletag.cmd.push(function() {
				apstag.setDisplayBids();
				unitsForSend.forEach(function(u) {
					u.hbm_zone.back += 1;
				});
				sendAdserverRequests(codesForSend);
			});
		});
	}

	pbjs.que.push(function() {
		pbjs.requestBids({
			timeout: PREBID_TIMEOUT,
			adUnitCodes: codesForSend,
			bidsBackHandler: function(){
                        console.log('unitsForSend^^');
                        console.log(codesForSend);
				unitsForSend.forEach(function(u) {
					u.hbm_zone.back += 1;
				});
//                                console.log('codesForSend^^');
//                                console.log(codesForSend);                            
				sendAdserverRequests(codesForSend);
			}
		});
	});

	setTimeout(function() {
		unitsForSend.forEach(function(u) {
			u.hbm_zone.back += (1 + APS);
		});
		sendAdserverRequests(codesForSend);
	}, FAILSAFE_TIMEOUT);
}

function intersectionObserverLazyLoading(entries, observer) {
	entries.forEach(function(entry) {
		var u = adUnits.filter(function(u) {
			return 'hbm-'+u.code === entry.target.id;
		})[0];
		if (u) {
			if (!u.hbm_zone.isLoaded && entry.intersectionRatio > 0) {
				u.hbm_zone.isLoaded = true;
				startAuction([u]);
				observer.unobserve(entry.target);
			}
		}
	});
};

function intersectionObserverRefresh(entries, observer) {
	entries.forEach(function(entry) {
		var u = adUnits.filter(function(u) {
			return 'hbm-'+u.code === entry.target.id;
		})[0];
		if (u) {
			u.hbm_zone.isVisible = entry.intersectionRatio > 0;
		}
	});
};

if (window.hbm_polyfill){
	window.hbm_polyfill.onload = function(){ onLoad(); }
}else{
	window.onload = function(){ onLoad(); }
}
function onLoad() {
	adUnits.filter(function(u) {
		return u.code && !u.hbm_zone.lazy_loading && u.hbm_zone.refresh;
	}).forEach(function(u) {
		setInterval(function() {
			u.hbm_zone.isRefresh = true;
			startAuction([u]);
		}, u.hbm_zone.refresh);
	});

	adUnits.filter(function(u) {
		return u.code && u.hbm_zone.lazy_loading;
	}).forEach(function(u) {
		var target = document.getElementById(u.code);
		if (target) {
			target.outerHTML = "<div id='hbm-"+u.code+"'>" + target.outerHTML + "</div>";
			var target2 = document.getElementById('hbm-'+u.code);
			var lazy_loading_offset = u.hbm_zone.lazy_loading_offset || 200;

			if (!('IntersectionObserver' in window)) {
				console.log("IntersectionObserver is undefined");
				return;
			}
			
			var observerLazyLoading = new IntersectionObserver(intersectionObserverLazyLoading, { root: null, rootMargin: "0px 0px "+lazy_loading_offset+"px 0px" });
			observerLazyLoading.observe(target2);
			if (u.hbm_zone.refresh) {
				var observerRefresh = new IntersectionObserver(intersectionObserverRefresh, { root: null, threshold: [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0] });
				observerRefresh.observe(target2);
			}
		}
	});

	adUnits.filter(function(u) {
		return u.code && u.hbm_zone.lazy_loading && u.hbm_zone.refresh;
	}).forEach(function(u) {
		setInterval(function() {
			if (u.hbm_zone.isLoaded && u.hbm_zone.isVisible) {
				u.hbm_zone.isRefresh = true;
				startAuction([u]);
			}
		}, u.hbm_zone.refresh);
	});
}

var resizeTimerId;
if (REFRESH_ONRESIZE) {
	window.addEventListener("resize", function() {
		clearTimeout(resizeTimerId);
		resizeTimerId = setTimeout(doneResizing, 1000);
	});
}

function doneResizing(){
	console.log("resized");

	adUnits.filter(function(u) {
		return u.code && !u.hbm_zone.lazy_loading;
	}).forEach(function(u) {
		u.hbm_zone.isRefresh = false;
		startAuction([u]);
	});

	adUnits.filter(function(u) {
		return u.code && u.hbm_zone.lazy_loading;
	}).forEach(function(u) {
		if (u.hbm_zone.isLoaded) {
			u.hbm_zone.isRefresh = false;
			startAuction([u]);
		}
	});
}

googletag.cmd.push(function() {
	adUnits.forEach(function(u) {
		var target = document.getElementById(u.code);
		if (target) {
			if (!target.innerHTML) {
				googletag.display(u.code);
			}
		}
	});
});

function HBManager() {}

HBManager.prototype.dynamic = function(divid, zoneid) {
	var u = adUnits.filter(function(u) {
		return u.hbm_zone.zoneid == zoneid;
	})[0];
	if (!u) return;

	var target = document.getElementById(divid);
	if (target && u.code !== divid) {
		googletag.cmd.push(function() {
			u.code = divid;
			if (u.hbm_zone.outofpage)
				u.hbm_zone.slot = googletag.defineOutOfPageSlot(u.hbm_zone.slot_code, u.code);
			else
				u.hbm_zone.slot = googletag.defineSlot(u.hbm_zone.slot_code, u.hbm_zone.slot_sizes, u.code);
			if (adMapping[u.hbm_zone.zoneid])
				u.hbm_zone.slot.defineSizeMapping(adMapping[u.hbm_zone.zoneid]);
			u.hbm_zone.slot.addService(googletag.pubads());
			googletag.display(u.code);
			u.hbm_zone.isRefresh = false;
			startAuction([u]);
		});
	}
};

HBManager.prototype.refresh = function(zoneid){
	var u = adUnits.filter(function(u) {
		return u.hbm_zone.zoneid == zoneid;
	})[0];
	if (!u) return;
	u.hbm_zone.isRefresh = false;
	startAuction([u]);
};

window.HBManager = HBManager; 

}(window, document, pbjs, googletag));

var hbManager = new HBManager();




